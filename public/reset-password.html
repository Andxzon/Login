<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recuperar Contraseña</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="shape shape-1"></div>
    <div class="shape shape-2"></div>

    <div class="login-card">
        <h2>RECUPERAR</h2>
        <h3 id="subtitle">Te enviaremos un código</h3>

        <!-- PASO 1: SOLICITAR CÓDIGO -->
        <form id="request-form">
            <div class="input-group">
                <input type="email" id="reset-email" placeholder="Tu Email Registrado" class="input-field" required>
            </div>
            <button type="submit" class="btn-login" id="btn-request">ENVIAR CÓDIGO</button>

            <div class="divider">
                <span>¿Ya tienes el código?</span>
            </div>

            <button type="button" class="btn-secondary" onclick="showResetForm()">Ingresar Código</button>
        </form>

        <!-- PASO 2: INGRESAR CÓDIGO Y NUEVA PASSWORD -->
        <form id="reset-form" style="display: none;">
            <div class="input-group">
                <input type="text" id="reset-code" placeholder="Código (6 dígitos)" class="input-field" maxlength="6"
                    required>
            </div>
            <div class="input-group">
                <input type="password" id="new-password" placeholder="Nueva Contraseña" class="input-field" required>
            </div>
            <button type="submit" class="btn-login" id="btn-reset">CAMBIAR CONTRASEÑA</button>

            <div class="divider"></div>

            <button type="button" class="btn-secondary" onclick="showRequestForm()">Regresar</button>
        </form>

        <div style="margin-top: 20px;">
            <a href="index.html" class="forgot-pass">Volver al Login</a>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3000/api/auth';

        const requestForm = document.getElementById('request-form');
        const resetForm = document.getElementById('reset-form');
        const subtitle = document.getElementById('subtitle');
        const emailInput = document.getElementById('reset-email');

        let currentEmail = '';

        function showResetForm() {
            requestForm.style.display = 'none';
            resetForm.style.display = 'block';
            subtitle.textContent = "Ingresa código y nueva clave";
        }

        function showRequestForm() {
            resetForm.style.display = 'none';
            requestForm.style.display = 'block';
            subtitle.textContent = "Te enviaremos un código";
        }

        function showMessage(msg, type = 'info') {
            alert(msg); // Simplificado para este ejemplo, podrías usar la misma función bonita de index.html
        }

        // Solicitar código
        requestForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = emailInput.value.trim();
            if (!email) return;

            const btn = document.getElementById('btn-request');
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = "Enviando...";

            try {
                const res = await fetch(`${API_URL}/forgot-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                const data = await res.json();

                if (data.status === 'success') {
                    currentEmail = email;
                    alert('Código enviado. Revisa tu correo (o la consola del servidor).');
                    showResetForm();
                } else {
                    alert(data.message);
                }
            } catch (err) {
                console.error(err);
                alert('Error de conexión');
            } finally {
                btn.disabled = false;
                btn.innerText = originalText;
            }
        });

        // Resetear contraseña
        resetForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const code = document.getElementById('reset-code').value.trim();
            const newPassword = document.getElementById('new-password').value;

            // Si el usuario saltó directamente al paso 2, intentamos usar el email del input del paso 1
            const email = currentEmail || emailInput.value.trim();

            if (!email) {
                alert('Por favor ingresa tu email en el paso anterior primero (o escríbelo en el campo oculto).');
                showRequestForm();
                return;
            }

            const btn = document.getElementById('btn-reset');
            btn.disabled = true;
            btn.innerText = "Procesando...";

            try {
                const res = await fetch(`${API_URL}/reset-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, code, newPassword })
                });
                const data = await res.json();

                if (data.status === 'success') {
                    alert('¡Contraseña actualizada! Ahora puedes iniciar sesión.');
                    window.location.href = 'index.html';
                } else {
                    alert(data.message);
                }
            } catch (err) {
                console.error(err);
                alert('Error al restablecer');
            } finally {
                btn.disabled = false;
                btn.innerText = "CAMBIAR CONTRASEÑA";
            }
        });

        // Estilos parallax simples
        document.addEventListener('mousemove', (e) => {
            const shapes = document.querySelectorAll('.shape');
            const x = (window.innerWidth - e.pageX * 2) / 100;
            const y = (window.innerHeight - e.pageY * 2) / 100;
            shapes.forEach((shape, index) => {
                const speed = index === 0 ? 2 : -2;
                shape.style.transform = `translateX(${x * speed}px) translateY(${y * speed}px)`;
            });
        });
    </script>
</body>

</html>